---
import BaseLayout from "@components/base/BaseLayout.astro";
import { getCollection, render } from "astro:content";
import "photoswipe/style.css";
import "photoswipe-dynamic-caption-plugin/photoswipe-dynamic-caption-plugin.css";

export async function getStaticPaths() {
  const galleries = await getCollection("gallery");
  return galleries.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);
const { title, description, cover, images, date } = entry.data;

const schema = {
  "@context": "https://schema.org",
  "@type": "ImageGallery",
  name: title,
  description: description,
  image: images?.map((img) => img.url) || [cover],
  url: Astro.url.href,
  datePublished: date ? date.toISOString() : undefined,
  author: {
    "@type": "Person",
    name: "小伍",
    url: "https://wuyuying.com",
  },
};
---

<BaseLayout
  title={title}
  description={description}
  image={cover}
  schema={schema}
>
  <section class="container p-8">
    <div class="text-center my-16 mb-32">
      <a
        href="/gallery"
        class="inline-flex items-center text-sm font-medium text-gray-500 hover:text-primary transition-colors mb-8"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-1"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd"></path>
        </svg>
         Back to Galleries
      </a>
      <h1 class="text-5xl font-bold mb-4">{title}</h1>
      {
        description && (
          <p class="text-xl text-neutral-600 dark:text-gray-400">
            {description}
          </p>
        )
      }

      <div
        id="gallery"
        class="mx-auto container my-8 sm:columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-4"
      >
        {
          images &&
            images.map((image) => (
              <div class="mb-4 break-inside-avoid">
                <a
                  href={image.url}
                  class="block cursor-zoom-in group"
                  style={{ opacity: "1 !important" }}
                >
                  <img
                    src={image.url}
                    alt={image.title || image.alt}
                    loading="lazy"
                    class="w-full border border-transparent hover:border-gray-300 dark:hover:border-gray-600 hover:shadow-xl"
                    style={{ clipPath: "inset(0 round 16px)" }}
                  />
                  {image.title && (
                    <>
                      <div class="pswp-caption-content" style="display: none">
                        {image.title}
                      </div>
                      <p class="text-xs text-left mt-1 text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity">
                        {image.title}
                      </p>
                    </>
                  )}
                </a>
              </div>
            ))
        }
      </div>

      <div
        class="mt-12 prose dark:prose-invert max-w-none text-left mx-auto glass px-8 py-8 rounded-lg"
      >
        <Content />
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";
  import PhotoSwipeDynamicCaption from "photoswipe-dynamic-caption-plugin";

  const gallery = document.getElementById("gallery");

  if (gallery) {
    // Helper to build datasource from current DOM
    const getDataSource = () => {
      return Array.from(gallery.querySelectorAll("a")).map((anchor) => {
        const img = anchor.querySelector("img");
        const width =
          Number(img?.naturalWidth) ||
          Number(anchor.getAttribute("data-pswp-width")) ||
          0;
        const height =
          Number(img?.naturalHeight) ||
          Number(anchor.getAttribute("data-pswp-height")) ||
          0;
        const caption =
          anchor.querySelector(".pswp-caption-content")?.innerHTML ||
          img?.alt ||
          "";

        return {
          src: anchor.href,
          w: width,
          h: height,
          alt: img?.alt || "",
          title: caption,
          msrc: img?.src, // thumbnail src for transition
          element: anchor, // used by photoswipe to calculate thumbnail bounds
        };
      });
    };

    gallery.addEventListener("click", async (e) => {
      // Robustly find anchor
      const target = e.target as HTMLElement;
      const anchor = target?.closest("a");

      if (!anchor || !gallery.contains(anchor)) return;

      e.preventDefault();

      // Ensure we have dimensions for the clicked item at minimum
      const img = anchor.querySelector("img");
      if (img && (!img.complete || img.naturalWidth === 0)) {
        return;
      }

      const items = getDataSource();
      const index = items.findIndex((item) => item.element === anchor);

      const lightbox = new PhotoSwipeLightbox({
        dataSource: items,
        index: index,
        pswpModule: () => import("photoswipe"),
        paddingFn: (viewportSize) => {
          return viewportSize.x < 700
            ? { top: 0, bottom: 0, left: 0, right: 0 }
            : { top: 30, bottom: 30, left: 70, right: 70 };
        },
      });

      // Plugins
      new PhotoSwipeDynamicCaption(lightbox, { type: "below" });

      // Custom Mobile Caption
      lightbox.on("uiRegister", function () {
        if (!lightbox.pswp?.ui) return;
        lightbox.pswp.ui.registerElement({
          name: "mobile-caption",
          order: 9,
          isButton: false,
          appendTo: "root",
          onInit: (el, pswp) => {
            el.className = "pswp-mobile-caption";
            pswp.on("change", () => {
              const currSlide = pswp.currSlide;
              if (currSlide && currSlide.data && currSlide.data.element) {
                const hiddenCaption = currSlide.data.element.querySelector(
                  ".pswp-caption-content",
                );
                el.innerHTML = hiddenCaption ? hiddenCaption.innerHTML : "";
              } else {
                el.innerHTML = "";
              }
            });
          },
        });
      });

      // Google Analytics Tracking
      lightbox.on("uiRegister", () => {
        const pswp = lightbox.pswp;
        if (!pswp) return;

        pswp.on("change", () => {
          const currSlide = pswp.currSlide;
          // @ts-ignore
          if (
            currSlide &&
            currSlide.data &&
            typeof (window as any).gtag !== "undefined"
          ) {
            // @ts-ignore
            (window as any).gtag("event", "view_item", {
              event_category: "gallery",
              event_label: currSlide.data.src,
            });
          }
        });
      });

      lightbox.init();
      lightbox.loadAndOpen(index); // Explicitly open the lightbox at the correct index
    });
  }
</script>

<style is:global>
  @media (max-width: 700px) {
    .pswp__button--arrow--prev,
    .pswp__button--arrow--next {
      top: auto !important;
      bottom: 20px !important;
      margin-top: 0 !important;
    }
    .pswp__button--arrow--prev {
      left: 20px !important;
      right: auto !important;
    }
    .pswp__button--arrow--next {
      left: auto !important;
      right: 20px !important;
    }

    /* Hide default dynamic caption on mobile */
    .pswp__dynamic-caption {
      display: none !important;
    }

    /* Custom Mobile Caption */
    .pswp-mobile-caption {
      position: absolute !important;
      bottom: 0 !important;
      left: 0 !important;
      width: 100% !important;
      background: rgba(0, 0, 0, 0.6) !important;
      color: white !important;
      padding: 12px 16px !important;
      box-sizing: border-box !important;
      z-index: 1500 !important; /* Above slides (1000) and UI (1500 usually safe) */
      text-align: left;
      font-size: 14px;
      line-height: 1.4;
      pointer-events: none; /* Let clicks pass through if needed, or auto */
      user-select: none;
    }
  }
</style>
